![image](/assets/images/main_logo.png)

# About
  Данный текст разделен на три части. Они не связанны между собой, за исключением того, что все они относятся к андроид приложениям.
  
  Часть 0 -  я расскажу, как можно модифицировать популярную игру для андроида, внедрив свой вредоносный код и использовать это, для Man-In-The-Disk атаки на приложение ЕГОВ/ЕНПФ.
  
  Часть 1 - мы обойдем SSL Pinning на примере приложения mEgov и GetContact.

  Часть 2 - мы поищем фотки ваших друзей по номеру телефона.
  
  Часть 3 - кейлоггер
  
# Часть 0. Заражаем андроид приложение

## Intro

  Допустим, вы используете на своем андроид телефоне приложения, которые используют ЭЦП, для получения различных услуг. С помощью нее, вы совершаете операции, которые имеют юридическую силу. Вы бы не хотели, чтобы кто-то еще имел доступ к вашей ЭЦП и пользовался ей вместо вас. Представьте, что в один прекрасный день, вы узнаете о том, что кто-то все же воспользовался ею. Вы задаетесь вопросом - как это могло произойти? Анализируете все свои последние действия. Свой телефон в руки никому не давали и нигде не оставляли/забывали. Никаких мутных программ на телефон не ставили.

  Ответ простой - вы скачали безобидное приложение, которое было модифицировано злоумышленником. Или же ваш ребенок, который иногда берет ваш телефон, установил какую-нибудь игру. 
  
  Цель - показать, как просто злоумышленник может модифицировать любое приложение, внедрив туда вредоносный код. И как важно относится к разрешениям, которые вы даете приложениям на телефоне.
  
  Внедрить можно любой функционал - запись с микрофона, фото с камеры, получение контактов/смс/паролей от бразуера и т.д. Мы будем внедрять код, который сканирует память телефона, ищет ЭЦП и отсылает на сервер. Для убедительности, внедряться будем в популярное приложение [Fruit Ninja](https://play.google.com/store/apps/details?id=com.halfbrick.fruitninjafree) (более 100 млн. скачиваний). Начнем издалека.
  
## Как вредоносные приложения попадают на телефон
 
### Локальные маркеты приложений Китая, Ирана и т.д
 
  Примеры: cafebazaar.ir, android.myapp.com, apkplz.net
  
  Данные площадки появились вследствии цензуры и блокировки Google сервисов. Обычно они содержат местные аналоги популярных приложений и их модификации. Такие модификации содержат якобы новые, крутые фичи, как [этот](https://apkplz.net/app/org.ir.talaeii) иранский телеграм. Однажды, я изучал одну иранскую малварь (отчет [Virustotal](https://www.virustotal.com/gui/file/1e6a821f5de824b91c6676742a521a8dcdd345f25a820befa11e5975fc8c39d3/community), которая сканила телефон на наличие приложений-клонов телеграма и делала нехорошие вещи. Список был следующим, что говорит о реальной популярности всех этих клонов:
  
  ```
  "com.hanista.mobogram"
  "org.ir.talaeii"
  "ir.hotgram.mobile.android"
  "ir.avageram.com"
  "org.thunderdog.challegram"
  "ir.persianfox.messenger"
  "com.telegram.hame.mohamad"
  "com.luxturtelegram.black"
  "com.talla.tgr"
  "com.mehrdad.blacktelegram"
  ```
  Скачать можете [тут](/assets/files/iranian_apk_infected.zip), пароль:infected. Сколько телеграмов видите в Top downloads? ([Источник](https://cafebazaar.ir))
  
  ![image](/assets/images/iran_telegrams.png)
  
  Чем плохи модификации популярных приложений? Вы никогда не знаете, что они на самом деле делают. К тому же, правительство не упускает возможность и публикуют свои модификации, естественно с инструментами для слежения за пользователем. Приложения с правительственной слежкой являются вредоносными по определению. [Здесь](https://cybershafarat.com/2016/01/20/farsitelegram/) можете почитать, как спалились иранские власти. Цитата оттуда:
  
> This looks to be developed to the specifications of the Iranian government enabling them to track every bit and byte put forward by users of the app.  
  
  А [Здесь](https://thehackernews.com/2016/11/hacking-android-smartphone.html) спалились китайцы. Цитата:
  
> Besides sniffing SMS message content, contact lists, call logs, location data and other personal user information and automatically sending them to AdUps every 72 hours, AdUps' software also has the capability to remotely install and update applications on a smartphone.
  
  Обычным пользователям защититься от такого практически невозможно, так как другого выбора нет - официальные источники усиленно блокируются, либо приложения предустанавливаются на все ввозимые телефоны. 
  
  И не сказать, что такие маркеты непопулярны, как вам 260 000 000 пользователей в месяц? ([Источник](https://www.appinchina.co/market/app-stores/))
  
  ![image](/assets/images/china_app_stores.png)
  
### Фишинг
Классический фишинг, только вместо загрузки непонятных скриптов или файлов, пользователю предлагают обновить WhatsApp, установить новый улучшенный Instagram и т.д. Пример:

![img](/assets/images/whatsapp_fishing.png)

[Источник](https://xakep.ru/2017/01/27/mobile-phishing/)

![img](/assets/images/fishing_2.jpg)

[Источник](https://android.stackexchange.com/questions/106899/what-should-i-do-about-this-pop-up-on-my-android-device)

> I then open CHROME BROWSER and type: www.XXXXXXXX.com - within a few seconds I get a popup with this: 

![img](/assets/images/fishing_3.png)

[Источник](https://www.bleepingcomputer.com/forums/t/576156/android-pop-uphijacker/)

### Телеграм боты/группы

Пример: @apkdl_bot, t.me/fun_android

  Вместо легитимного приложения, вам могут подсунуть вредоносное. Либо заразить запрашиваемое вами приложение "на лету". Работает это так - вы вводите команду боту/в группу, что хотите скачать "Instagram". Скрипт на другой стороне скачивает его с Google Play, распаковывает, запихивает свой вредоносный код, запаковывает обратно и возвращает вам. Как это делать автоматически, я попытаюсь рассказать в ближайшем будущем.

### Сторонние сайты-посредники
 
 Пример: apkpure.com, apkmirror.com
 
 Тоже самое, что и с телеграм ботами/группами, только добавляется возможность загрузить свое приложение на такой сайт. Это в свою очередь только увеличивает вероятность установить вредоносное приложение. Пример загрузки на [этом сайте](https://www.apkmirror.com/#uploadAPK):
 
 ![img](/assets/images/apkmirror_submit.png)
   
  Один из примеров малвари, которая распостранялась таким образом ([Источник](https://www.cmcm.com/blog/en/security/2015-09-18/799.html)):
  
  ![img](/assets/images/how_ghost_push_work.jpg)
  
  Примерную статистику, для неофициальных источников, можно найти в [Android Security Report 2018](https://source.android.com/security/reports/Google_Android_Security_2018_Report_Final.pdf) - 1.6 миллиардов заблокированных Google Play Protect установок не из Google Play. Всего установок было гораздо больше.
  
### Google play
 
 Официальный источник приложений имеет защиту от малвари, под названием Google Play Protect, которая использует машинное обучение для определения степени вредоносности. Но такая защита не в состоянии точно понять, какое приложение вредоносное, а какое нет, так как для этого требуется полная ручная проверка. Чем отличается шпионское приложение, которое мониторит все ваши передвижения, от фитнес приложения для бега? Исследователи каждый месяц [находят](https://www.zdnet.com/article/android-security-flashlight-apps-on-google-play-infested-with-adware-were-downloaded-by-1-5m-people/) [сотнями](https://www.zdnet.com/article/google-malware-in-google-play-doubled-in-2018-because-of-click-fraud-apps/) [зараженные](https://www.express.co.uk/life-style/science-technology/1143651/Android-warning-malware-Google-Play-Store-security-June-23) приложения, опубликованные в Google Play.
  
  Обычно малварь называет себя *google play services* или схожим образом и ставит такую же иконку ([пример](https://www.zdnet.com/article/this-trojan-masquerades-as-google-play-to-hide-on-your-phone)). Почему гугл плей не проверяет иконку на схожесть со своими официальными приложениями - непонятно. В телеграме, если вы поставите аватарку с бумажным самолетиком вас сразу заблокируют. Еще один способ, используемый для публикации в Google Play, состоит в создании схожего имени, с заменой буквы "L" на "I":
  
  
  ![image](/assets/images/spoil_name.png) 
  
  [Источник](https://ti.360.net/blog/articles/stealjob-new-android-malware-used-by-donot-apt-group-en/). 
  
  Тем самым вы по ошибке можете скачать не то приложение, которое хотели и оно в свою очередь, сворует все ваши контакты и поставит еще много чего вам на телефон. 

Надеюсь вы теперь поняли, что приложение с вредоносным функционалом на вашем телефоне, это не миф, а реальность. Ну а если вы все еще скептически относитесь к этой проблеме, то я вам покажу, в образовательных целях, как злоумышленник, легко и просто может внедрить вредоносный код в легитимное приложение. Надеюсь вы уже поняли, что такое приложение может попасть к вам на телефон тысячими способов. Вредоносный функционал может быть очень обширный, от прослушивания через микрофон, до повышения привелегий до рута. Но мы рассмотрим лишь один из них, эксплуатацию вектора Man-In-The-Disk.

### Другие способы

К ним относятся: [установка малвари в сервисах починки телефонов](https://www.thesun.co.uk/tech/4298260/smartphone-screen-repair-shops-could-let-spies-into-your-phone/), [при пересечении границы](https://www.theguardian.com/world/2019/jul/02/chinese-border-guards-surveillance-app-tourists-phones), подключение к USB с включенным режимом отладки или злоумышленник получит доступ к вашему гугл аккаунту, и установит приложение с компьютера, через Google Play. 

### Вывод

Теперь мы поняли, что наше зараженное приложение может попасть на телефон пользователя множеством способов. Теперь о способе атаки, для получения ЭЦП. 

### Man-In-The-Disk

Проблема стара как мир. ПРактически все обратили внимание на эту проблему, после статьи (https://blog.checkpoint.com/2018/08/12/man-in-the-disk-a-new-attack-surface-for-android-apps/). Все начали писать об этом. Одна часть людей отнеслась к этому скептически.

*Для тех кто прочитал статью выше. В исследовании не развили мысль о том, что эти файлы обрабатываются простыми библиотеками, в которых можно найти уязвимость и скрафтить такие файлы, которые позволят натворить много плохого.

Кто не прочитал, расскажу в кратце, своими словами + свое виденье этой проблемы + перейдем ближе к сути. Для начала, определимся с понятями. В андроиде память разделяется на Internal Storage и External Storage. Internal storage - это внутренняя папка приложения. Абсолютно каждому приложению на телефоне соответствует отдельный пользователь и отдельная папка с правами только для этого пользователя. Это отличный защитный механизм, никакое приложение на телефоне, не имеет доступа к данным любого другого приложения. External storage - основная память телефона, доступная всем приложениям. Или другими словами - внешнее хранилище. Возьмем приложение фоторедактор. После редактирования, вы должны сохранить фото, чтобы оно было доступно из Галереи. Естественно, что если вы положите его в internal storage, то никому, кроме вашего приложения оно доступно не будет. Сюда же относится ваша SD карта и все что на ней хранится (есть даже опция, хранить данные приложения на sd карте). С этим разобрались. 

У каждого андроид приложения есть свой набор разрешений, которые оно запрашивает. Но с ними все не так хорошо. Среди них есть такие, на которые люди охотно закрывают глаза. Среди них - READ_EXTERNAL_STORAGE. Оно позволяет приложению получать доступ к основной памяти телефона, а значит и ко всем данным других приложений, которые хранят свои данные там. Манипуляция данными других приложений в external storage и назвыается ManInTheDisk! 

  Небольшое отступление - если поставить whatsapp на рутованый телефон, то все ваши переписки хранятся в external storage незашифрованными. Видимо whatsapp не считает нужным даже использовать шифрование, на таком "порченом" телефоне. А на нерутованом, там лежит SSLSessionCache. И кто знает, чем это может грозить.   

Если вы все еще считаете, что это бесперспективный и слабый вектор, то гугл так не считает. Гугл специально для этого изменил READ_EXTERNAL_STORAGE, Кому интересно, читаем здесь (https://developer.android.com/preview/privacy/scoped-storage?hl=ru). В кратце, цитата а - 
> In order to access any other file that another app has created, including files in a "downloads" directory, your app must use the Storage Access Framework, which allows the user to select a specific file.

То есть, юзер тепер сам выбирает, какие именно файлы, какому приложению, доступны в external storage. Слава богу, Android Q не стоит у каждого казахстанца и слава богу, наши приложения, по работе с эцп, берут их из общедоступного хранилища. Это значит, мы можем провести maninthedisk и своровать эцп! А как это сделать? Правильно, заразить легитимное приложение. Как на лету подменить легитимное приложение читайте во второй части (напомню, которая еще не вышла!)

Почему maninthedisk может быть легко эксплутируем? 
